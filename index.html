<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kitchen Dashboard</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
padding: 20px;
min-height: 100vh;
transition: background 0.8s ease, color 0.8s ease;
}
body.light-theme {
background: linear-gradient(to bottom, #e3f2fd 0%, #f5f7fa 50%, #fafafa 100%);
color: #2c3e50;
}
body.dark-theme {
background: linear-gradient(to bottom, #1a1a2e 0%, #16213e 50%, #0f0f1e 100%);
color: white;
}
.setup-container {
max-width: 800px;
margin: 50px auto;
padding: 40px;
background: white;
border-radius: 20px;
box-shadow: 0 8px 24px rgba(0,0,0,0.15);
color: #2c3e50;
}
.setup-container h1 { margin-bottom: 10px; }
.setup-container p { color: #666; margin-bottom: 30px; }
.setup-section { margin-bottom: 30px; }
.setup-section h3 { margin-bottom: 15px; font-size: 18px; }
.setup-input {
width: 100%;
padding: 12px;
margin-bottom: 10px;
border: 2px solid #e0e0e0;
border-radius: 8px;
font-size: 14px;
}
.setup-input:focus { outline: none; border-color: #4da6ff; }
.setup-button {
width: 100%;
padding: 15px;
background: #4da6ff;
color: white;
border: none;
border-radius: 8px;
font-size: 16px;
font-weight: 600;
cursor: pointer;
}
.setup-button:hover { background: #3d96ef; }
.container { max-width: 1800px; margin: 0 auto; display: none; }
.container.active { display: block; }
.header {
display: grid;
grid-template-columns: 1fr 2fr 1fr;
gap: 20px;
margin-bottom: 24px;
padding-bottom: 24px;
}
.light-theme .header { border-bottom: 2px solid rgba(0,0,0,0.1); }
.dark-theme .header { border-bottom: 2px solid rgba(255,255,255,0.1); }
.time-section { text-align: left; display: flex; flex-direction: column; justify-content: center; }
.time { font-size: 56px; font-weight: 300; margin-bottom: 5px; }
.date { font-size: 18px; opacity: 0.8; line-height: 1.4; }
.photo-section {
  position: relative;
  border-radius: 20px;
  overflow: hidden;
  box-shadow: 0 8px 24px rgba(0,0,0,0.15);
  height: 100%;
}
.light-theme .photo-section {
background: linear-gradient(135deg, rgba(0,0,0,0.05) 0%, rgba(0,0,0,0.02) 100%);
border: 1px solid rgba(0,0,0,0.08);
}
.dark-theme .photo-section {
background: linear-gradient(135deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.03) 100%);
border: 1px solid rgba(255,255,255,0.1);
}
.photo-frame { position: relative; width: 100%; height: 100%; }
.photo-image {
position: absolute;
top: 0;
left: 0;
width: 100%;
height: 100%;
object-fit: cover;
opacity: 0;
transition: opacity 1s ease-in-out;
}
.photo-image.active { opacity: 1; z-index: 1; }
.photo-placeholder {
display: flex;
align-items: center;
justify-content: center;
flex-direction: column;
width: 100%;
height: 100%;
font-size: 64px;
opacity: 0.3;
}
.weather-card {
border-radius: 20px;
padding: 24px;
box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.light-theme .weather-card {
background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
border: 1px solid rgba(0,0,0,0.08);
}
.dark-theme .weather-card {
background: linear-gradient(135deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.05) 100%);
border: 1px solid rgba(255,255,255,0.1);
}
.weather-card h2 { font-size: 18px; margin-bottom: 16px; opacity: 0.9; padding-bottom: 12px; font-weight: 600; }
.light-theme .weather-card h2 { border-bottom: 1px solid rgba(0,0,0,0.1); }
.dark-theme .weather-card h2 { border-bottom: 1px solid rgba(255,255,255,0.1); }
.weather-current { display: flex; align-items: center; gap: 15px; margin-bottom: 16px; }
.weather-icon { font-size: 42px; }
.temp-section { flex: 1; }
.temp { font-size: 36px; font-weight: 300; }
.feels-like { font-size: 14px; opacity: 0.7; margin-top: 4px; }
.weather-details { font-size: 13px; opacity: 0.8; line-height: 1.8; }
.sun-times { display: flex; gap: 20px; margin-top: 12px; padding-top: 12px; font-size: 13px; opacity: 0.8; }
.light-theme .sun-times { border-top: 1px solid rgba(0,0,0,0.08); }
.dark-theme .sun-times { border-top: 1px solid rgba(255,255,255,0.08); }
.sun-time { display: flex; align-items: center; gap: 6px; }
.forecast { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 16px; }
.forecast-day { padding: 10px; border-radius: 12px; text-align: center; font-size: 12px; }
.light-theme .forecast-day { background: rgba(0,0,0,0.03); }
.dark-theme .forecast-day { background: rgba(255,255,255,0.05); }
.forecast-day .day { font-weight: 600; margin-bottom: 6px; }
.forecast-day .icon { font-size: 24px; margin: 6px 0; }
.forecast-day .temp { font-size: 16px; font-weight: 600; margin: 6px 0; }
.forecast-day .rain { opacity: 0.7; font-size: 11px; margin-top: 4px; }
.calendar { border-radius: 20px; padding: 24px; margin-bottom: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
.light-theme .calendar { background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); border: 1px solid rgba(0,0,0,0.08); }
.dark-theme .calendar { background: linear-gradient(135deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.05) 100%); border: 1px solid rgba(255,255,255,0.1); }
.calendar h2 { font-size: 22px; margin-bottom: 20px; opacity: 0.9; padding-bottom: 12px; font-weight: 600; }
.light-theme .calendar h2 { border-bottom: 1px solid rgba(0,0,0,0.1); }
.dark-theme .calendar h2 { border-bottom: 1px solid rgba(255,255,255,0.1); }
.calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
.calendar-header { text-align: center; font-weight: 600; font-size: 12px; padding: 12px 5px; opacity: 0.7; text-transform: uppercase; }
.calendar-day { min-height: 85px; padding: 8px; border-radius: 12px; position: relative; }
.light-theme .calendar-day { background: rgba(0,0,0,0.02); }
.dark-theme .calendar-day { background: rgba(255,255,255,0.03); }
.calendar-day.today { border: 2px solid #4da6ff; }
.day-number { font-size: 14px; font-weight: 600; margin-bottom: 6px; }
.day-events { font-size: 10px; line-height: 1.5; }
.day-event { padding: 2px 4px; margin-bottom: 2px; border-radius: 4px; background: rgba(77, 166, 255, 0.2); }
.tasks-section { border-radius: 20px; padding: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
.light-theme .tasks-section { background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); border: 1px solid rgba(0,0,0,0.08); }
.dark-theme .tasks-section { background: linear-gradient(135deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.05) 100%); border: 1px solid rgba(255,255,255,0.1); }
.tasks-section h2 { font-size: 22px; margin-bottom: 20px; opacity: 0.9; padding-bottom: 12px; font-weight: 600; }
.light-theme .tasks-section h2 { border-bottom: 1px solid rgba(0,0,0,0.1); }
.dark-theme .tasks-section h2 { border-bottom: 1px solid rgba(255,255,255,0.1); }
.kanban-board { display: flex; gap: 20px; }
.kanban-column { min-width: 300px; flex: 1; border-radius: 16px; padding: 16px; }
.light-theme .kanban-column { background: rgba(0,0,0,0.02); }
.dark-theme .kanban-column { background: rgba(255,255,255,0.03); }
.kanban-column h3 { font-size: 16px; margin-bottom: 16px; color: #4da6ff; }
.task-item { border-radius: 12px; padding: 14px; margin-bottom: 10px; font-size: 14px; border-left: 3px solid #4da6ff; display: flex; align-items: flex-start; gap: 12px; }
.light-theme .task-item { background: #ffffff; box-shadow: 0 2px 4px rgba(0,0,0,0.08); }
.dark-theme .task-item { background: rgba(255,255,255,0.08); }
.task-checkbox { width: 20px; height: 20px; border-radius: 6px; border: 2px solid rgba(0,0,0,0.3); flex-shrink: 0; cursor: pointer; }
.task-text { flex: 1; line-height: 1.5; }
.calendar-controls {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}
.calendar-btn {
  padding: 8px 16px;
  background: #4da6ff;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
}
.calendar-btn:hover {
  background: #3d96ef;
}
.calendar-title {
  font-size: 22px;
  font-weight: 600;
}
</style>
</head>
<body class="light-theme">
<div class="setup-container" id="setupPage">
<h1>üè† Dashboard Setup</h1>
<p>Enter your API credentials once. They'll be saved securely in your browser.</p>
<form id="setupForm">
<div class="setup-section">
<h3>‚õÖ Weather Underground</h3>
<input type="text" class="setup-input" id="wu_key" placeholder="API Key" required>
<input type="text" class="setup-input" id="wu_station" placeholder="Station ID (e.g., IJORDA5)" required>
</div>
<div class="setup-section">
<h3>üå¶Ô∏è OpenWeatherMap</h3>
<input type="text" class="setup-input" id="owm_key" placeholder="API Key" required>
<input type="text" class="setup-input" id="owm_lat" placeholder="Latitude" required>
<input type="text" class="setup-input" id="owm_lon" placeholder="Longitude" required>
</div>
<div class="setup-section">
<h3>üìÖ Google Calendar</h3>
<input type="text" class="setup-input" id="gcal_key" placeholder="API Key" required>
<input type="text" class="setup-input" id="gcal_ids" placeholder="Calendar IDs (comma-separated)" required>
</div>
<div class="setup-section">
<h3>‚úÖ Google Tasks</h3>
<p style="font-size: 13px; opacity: 0.7; margin-bottom: 10px;">You'll authorize with Google after setup</p>
<input type="text" class="setup-input" id="gtask_lists" placeholder="Task Lists (e.g., To Do,Doing)" required>
</div>
<button type="submit" class="setup-button">üíæ Save & Start Dashboard</button>
</form>
</div>
<div class="container" id="dashboard">
<div class="header">
<div class="time-section">
<div class="time" id="time">00:00:00</div>
<div class="date" id="date">Loading...</div>
</div>
<div class="photo-section">
<div class="photo-frame" id="photoFrame">
<div class="photo-placeholder">üì∑</div>
</div>
</div>
<div class="weather-card">
<h2>üå§Ô∏è Weather</h2>
<div class="weather-current">
<div class="weather-icon" id="weatherIcon">‚òÄÔ∏è</div>
<div class="temp-section">
<div class="temp" id="temp">--¬∞C</div>
<div class="feels-like" id="feelsLike">--</div>
</div>
</div>
<div class="weather-details" id="weatherDetails">Loading...</div>
<div class="sun-times">
<div class="sun-time"><span>üåÖ</span><span id="sunrise">--:--</span></div>
<div class="sun-time"><span>üåá</span><span id="sunset">--:--</span></div>
</div>
<div class="forecast" id="forecast"></div>
</div>
</div>
<div class="calendar">
<h2 id="calendarHeader">üìÖ Loading...</h2>
<div id="calendarEvents">Loading calendar...</div>
</div>
<div class="tasks-section">
<h2>‚úÖ Tasks</h2>
<div id="tasksAuthPrompt" style="display: none; text-align: center; padding: 40px;">
<p style="font-size: 18px; margin-bottom: 20px;">üìã Authorize Google Tasks</p>
<button id="authTasksBtn" style="padding: 15px 30px; font-size: 16px; background: #4da6ff; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">üîê Authorize Tasks</button>
</div>
<div class="kanban-board" id="kanbanBoard">
<div class="kanban-column"><h3>Loading...</h3></div>
</div>
</div>
</div>
<script>
let CONFIG = {};
let calendarOffset = 0;
function loadConfig() {
  const saved = localStorage.getItem('dashboardConfig');
  if (saved) {
    CONFIG = JSON.parse(saved);
    return true;
  }
  return false;
}

function saveConfig(formData) {
  CONFIG = {
    WEATHER_UNDERGROUND: {
      API_KEY: formData.wu_key,
      STATION_ID: formData.wu_station
    },
    OPENWEATHERMAP: {
      API_KEY: formData.owm_key,
      LAT: parseFloat(formData.owm_lat),
      LON: parseFloat(formData.owm_lon)
    },
    GOOGLE_CALENDAR: {
      API_KEY: formData.gcal_key,
      CALENDAR_IDS: formData.gcal_ids.split(',').map(s => s.trim())
    },
    GOOGLE_TASKS: {
      TASK_LISTS: formData.gtask_lists.split(',').map(s => s.trim())
    }
  };
  localStorage.setItem('dashboardConfig', JSON.stringify(CONFIG));
}

const GTASK_CLIENT_ID = '188207033000-d4gpeivpi6f89tc2155ua165bk1bcplo.apps.googleusercontent.com';
const GTASK_CLIENT_SECRET = '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';
const GTASK_SCOPES = 'https://www.googleapis.com/auth/tasks';

document.getElementById('setupForm').addEventListener('submit', (e) => {
  e.preventDefault();
  const formData = {
    wu_key: document.getElementById('wu_key').value,
    wu_station: document.getElementById('wu_station').value,
    owm_key: document.getElementById('owm_key').value,
    owm_lat: document.getElementById('owm_lat').value,
    owm_lon: document.getElementById('owm_lon').value,
    gcal_key: document.getElementById('gcal_key').value,
    gcal_ids: document.getElementById('gcal_ids').value,
    gtask_lists: document.getElementById('gtask_lists').value
  };
  saveConfig(formData);
  initDashboard();
});

function getRedirectUri() {
  return window.location.origin + window.location.pathname;
}

function startGoogleTasksAuth() {
  const redirectUri = getRedirectUri();
  const authUrl = 'https://accounts.google.com/o/oauth2/v2/auth?' +
    'client_id=' + encodeURIComponent(GTASK_CLIENT_ID) +
    '&redirect_uri=' + encodeURIComponent(redirectUri) +
    '&response_type=code' +
    '&scope=' + encodeURIComponent(GTASK_SCOPES) +
    '&access_type=offline' +
    '&prompt=consent';
  window.location.href = authUrl;
}

async function handleOAuthCallback() {
  const urlParams = new URLSearchParams(window.location.search);
  const code = urlParams.get('code');
  if (!code) return false;
  
  try {
    const redirectUri = getRedirectUri();
    const response = await fetch('https://oauth2.googleapis.com/token', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        code: code,
        client_id: GTASK_CLIENT_ID,
        client_secret: GTASK_CLIENT_SECRET,
        redirect_uri: redirectUri,
        grant_type: 'authorization_code'
      })
    });
    
    const data = await response.json();
    if (data.access_token && data.refresh_token) {
      const config = JSON.parse(localStorage.getItem('dashboardConfig'));
      if (!config.GOOGLE_TASKS) config.GOOGLE_TASKS = {};
      config.GOOGLE_TASKS.ACCESS_TOKEN = data.access_token;
      config.GOOGLE_TASKS.REFRESH_TOKEN = data.refresh_token;
      localStorage.setItem('dashboardConfig', JSON.stringify(config));
      window.history.replaceState({}, document.title, window.location.pathname);
      location.reload();
      return true;
    }
  } catch (error) {
    console.error('OAuth error:', error);
  }
  return false;
}

function setupTasksAuth() {
  const authBtn = document.getElementById('authTasksBtn');
  if (authBtn) authBtn.addEventListener('click', startGoogleTasksAuth);
}

function checkTasksAuth() {
  if (CONFIG.GOOGLE_TASKS && CONFIG.GOOGLE_TASKS.ACCESS_TOKEN) {
    document.getElementById('tasksAuthPrompt').style.display = 'none';
    currentAccessToken = CONFIG.GOOGLE_TASKS.ACCESS_TOKEN;
    updateTasks();
    setInterval(updateTasks, 300000);
  } else {
    document.getElementById('tasksAuthPrompt').style.display = 'block';
    document.getElementById('kanbanBoard').style.display = 'none';
  }
}

let photoUrls = [];
let currentPhotoIndex = 0;

async function loadGitHubPhotos() {
  try {
    const pathParts = window.location.pathname.split('/').filter(p => p);
    const repoName = pathParts[0] || 'kitchen-dashboard';
    const username = 'asm024';
    const apiUrl = 'https://api.github.com/repos/' + username + '/' + repoName + '/contents/photos';
    const response = await fetch(apiUrl);
    const files = await response.json();
    photoUrls = files.filter(file => /\.(jpg|jpeg|png|gif)$/i.test(file.name)).map(file => file.download_url);
    console.log('Loaded ' + photoUrls.length + ' photos');
    if (photoUrls.length > 0) {
      showNextPhoto();
      setInterval(showNextPhoto, 45000);
    }
  } catch (error) {
    console.error('Photo load error:', error);
  }
}

function showNextPhoto() {
  if (photoUrls.length === 0) return;
  const photoFrame = document.getElementById('photoFrame');
  const currentImg = photoFrame.querySelector('.photo-image.active');
  const newImg = document.createElement('img');
  newImg.className = 'photo-image';
  newImg.src = photoUrls[currentPhotoIndex];
  newImg.alt = 'Family photo';
  newImg.onload = () => {
    const placeholder = photoFrame.querySelector('.photo-placeholder');
    if (placeholder) placeholder.remove();
    photoFrame.appendChild(newImg);
    setTimeout(() => newImg.classList.add('active'), 50);
    setTimeout(() => { if (currentImg) currentImg.remove(); }, 1500);
  };
  currentPhotoIndex = (currentPhotoIndex + 1) % photoUrls.length;
}

function updateTheme() {
  const hour = new Date().getHours();
  document.body.className = (hour >= 6 && hour < 18) ? 'light-theme' : 'dark-theme';
}

function updateTime() {
  const now = new Date();
  document.getElementById('time').textContent = now.toLocaleTimeString('en-AU', { hour: 'numeric', minute: '2-digit', second: '2-digit', hour12: true });
  document.getElementById('date').textContent = now.toLocaleDateString('en-AU', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
  updateTheme();
}

async function updateWeather() {
  try {
    // Get current weather from Weather Underground
    const wuUrl = 'https://api.weather.com/v2/pws/observations/current?stationId=' + CONFIG.WEATHER_UNDERGROUND.STATION_ID + '&format=json&units=m&apiKey=' + CONFIG.WEATHER_UNDERGROUND.API_KEY;
    const wuResponse = await fetch(wuUrl);
    const wuData = await wuResponse.json();
    const obs = wuData.observations[0];
    
    const temp = Math.round(obs.metric.temp);
    document.getElementById('temp').textContent = temp + '¬∞C';
    document.getElementById('feelsLike').textContent = 'Feels like ' + Math.round(obs.metric.heatIndex || temp) + '¬∞C';
    document.getElementById('weatherDetails').innerHTML = 'Humidity: ' + obs.humidity + '%<br>Wind: ' + Math.round(obs.metric.windSpeed) + ' km/h<br>Rain: ' + obs.metric.precipTotal + 'mm';
    
    let icon = '‚òÄÔ∏è';
    if (obs.solarRadiation < 200) icon = 'üåô';
    else if (obs.humidity > 80) icon = 'üåßÔ∏è';
    else if (obs.humidity > 60) icon = '‚õÖ';
    document.getElementById('weatherIcon').textContent = icon;
    
    // Get sunrise/sunset from OpenWeatherMap
    const owmUrl = 'https://api.openweathermap.org/data/2.5/weather?lat=' + CONFIG.OPENWEATHERMAP.LAT + '&lon=' + CONFIG.OPENWEATHERMAP.LON + '&appid=' + CONFIG.OPENWEATHERMAP.API_KEY;
    const owmResponse = await fetch(owmUrl);
    const owmData = await owmResponse.json();
    
    const sunrise = new Date(owmData.sys.sunrise * 1000);
    const sunset = new Date(owmData.sys.sunset * 1000);
    document.getElementById('sunrise').textContent = sunrise.toLocaleTimeString('en-AU', { hour: 'numeric', minute: '2-digit', hour12: true });
    document.getElementById('sunset').textContent = sunset.toLocaleTimeString('en-AU', { hour: 'numeric', minute: '2-digit', hour12: true });
  } catch (error) {
    console.error('Weather error:', error);
  }
}

async function updateForecast() {
  try {
    const url = 'https://api.openweathermap.org/data/2.5/forecast?lat=' + CONFIG.OPENWEATHERMAP.LAT + '&lon=' + CONFIG.OPENWEATHERMAP.LON + '&appid=' + CONFIG.OPENWEATHERMAP.API_KEY + '&units=metric';
    const response = await fetch(url);
    const data = await response.json();
    const dailyForecasts = {};
    data.list.forEach(item => {
      const date = new Date(item.dt * 1000);
      const dayKey = date.toLocaleDateString('en-AU', { weekday: 'short' });
      const hour = date.getHours();
      if (!dailyForecasts[dayKey] || Math.abs(hour - 12) < Math.abs(dailyForecasts[dayKey].hour - 12)) {
        dailyForecasts[dayKey] = {
          day: dayKey,
          temp: Math.round(item.main.temp),
          rain: item.rain ? item.rain['3h'] || 0 : 0,
          pop: Math.round(item.pop * 100),
          icon: item.weather[0].main,
          hour: hour
        };
      }
    });
    const forecasts = Object.values(dailyForecasts).slice(0, 4);
    document.getElementById('forecast').innerHTML = forecasts.map(f => {
      let weatherIcon = '‚òÄÔ∏è';
      if (f.icon === 'Rain') weatherIcon = 'üåßÔ∏è';
      else if (f.icon === 'Clouds') weatherIcon = '‚òÅÔ∏è';
      return '<div class="forecast-day"><div class="day">' + f.day + '</div><div class="icon">' + weatherIcon + '</div><div class="temp">' + f.temp + '¬∞C</div><div class="rain">' + f.pop + '%</div></div>';
    }).join('');
  } catch (error) {
    console.error('Forecast error:', error);
  }
}

async function updateCalendar() {
  try {
    const now = new Date();
    const startOfWeek = new Date(now);
    startOfWeek.setDate(now.getDate() - now.getDay() + (calendarOffset * 7));
    const endDate = new Date(startOfWeek);
    endDate.setDate(endDate.getDate() + 27);
    const headerText = startOfWeek.getMonth() === endDate.getMonth() ? startOfWeek.toLocaleDateString('en-AU', { month: 'long', year: 'numeric' }) : startOfWeek.toLocaleDateString('en-AU', { month: 'short' }) + ' - ' + endDate.toLocaleDateString('en-AU', { month: 'long', year: 'numeric' });
    const timeMin = startOfWeek.toISOString();
    const timeMax = endDate.toISOString();
    const allEvents = [];
    for (const calendarId of CONFIG.GOOGLE_CALENDAR.CALENDAR_IDS) {
      const url = 'https://www.googleapis.com/calendar/v3/calendars/' + encodeURIComponent(calendarId) + '/events?key=' + CONFIG.GOOGLE_CALENDAR.API_KEY + '&timeMin=' + timeMin + '&timeMax=' + timeMax + '&singleEvents=true&orderBy=startTime';
      const response = await fetch(url);
      const data = await response.json();
      if (data.items) allEvents.push(...data.items);
    }
    let html = '<div class="calendar-controls"><button class="calendar-btn" onclick="previousMonth()">‚Üê Previous</button><div class="calendar-title">üìÖ ' + headerText + '</div><button class="calendar-btn" onclick="nextMonth()">Next ‚Üí</button></div><div class="calendar-grid">';
    ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => { html += '<div class="calendar-header">' + day + '</div>'; });
    for (let i = 0; i < 28; i++) {
      const date = new Date(startOfWeek);
      date.setDate(startOfWeek.getDate() + i);
      const isToday = date.toDateString() === now.toDateString();
      const dateStr = date.toISOString().split('T')[0];
      const dayEvents = allEvents.filter(event => { const eventDate = event.start.date || event.start.dateTime?.split('T')[0]; return eventDate === dateStr; });
      let eventsHtml = dayEvents.slice(0, 3).map(event => '<div class="day-event">' + event.summary + '</div>').join('');
      if (dayEvents.length > 3) eventsHtml += '<div class="day-event">+' + (dayEvents.length - 3) + ' more</div>';
      html += '<div class="calendar-day' + (isToday ? ' today' : '') + '"><div class="day-number">' + date.getDate() + '</div><div class="day-events">' + eventsHtml + '</div></div>';
    }
    html += '</div>';
    document.getElementById('calendarEvents').innerHTML = html;
  } catch (error) {
    console.error('Calendar error:', error);
  }
}

async function updateTasks() {
  try {
    const listsUrl = 'https://www.googleapis.com/tasks/v1/users/@me/lists';
    const listsResponse = await fetch(listsUrl, { headers: { 'Authorization': 'Bearer ' + currentAccessToken } });
    if (listsResponse.status === 401) {
      await refreshAccessToken();
      return updateTasks();
    }
    const listsData = await listsResponse.json();
    if (!listsData.items) return;
    const wantedLists = listsData.items.filter(list => CONFIG.GOOGLE_TASKS.TASK_LISTS.includes(list.title));
    let kanbanHTML = [];
    for (const list of wantedLists) {
      const tasksUrl = 'https://www.googleapis.com/tasks/v1/lists/' + list.id + '/tasks';
      const tasksResponse = await fetch(tasksUrl, { headers: { 'Authorization': 'Bearer ' + currentAccessToken } });
      const tasksData = await tasksResponse.json();
      const tasks = (tasksData.items || []).filter(t => t.status !== 'completed');
      let tasksHTML = tasks.length === 0 ? '<div style="opacity: 0.5;">No tasks</div>' : tasks.map(task => '<div class="task-item" draggable="true" data-task-id="' + task.id + '" data-list-id="' + list.id + '"><div class="task-checkbox"></div><div class="task-text">' + task.title + '</div></div>').join('');
      kanbanHTML.push('<div class="kanban-column" data-list-id="' + list.id + '"><h3>' + list.title + '</h3>' + tasksHTML + '</div>');
    }
    document.getElementById('kanbanBoard').innerHTML = kanbanHTML.join('');
    makeDraggable();
  } catch (error) {
    console.error('Tasks error:', error);
  }
}

function makeDraggable() {
  const taskItems = document.querySelectorAll('.task-item');
  const columns = document.querySelectorAll('.kanban-column');
  
  taskItems.forEach(item => {
    item.draggable = true;
    
    item.addEventListener('dragstart', (e) => {
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', item.dataset.taskId);
      e.dataTransfer.setData('fromList', item.dataset.listId);
      item.style.opacity = '0.5';
    });
    
    item.addEventListener('dragend', (e) => {
      item.style.opacity = '1';
    });
  });
  
  columns.forEach(column => {
    column.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      column.style.background = 'rgba(77, 166, 255, 0.1)';
    });
    
    column.addEventListener('dragleave', (e) => {
      column.style.background = '';
    });
    
    column.addEventListener('drop', async (e) => {
      e.preventDefault();
      column.style.background = '';
      
      const taskId = e.dataTransfer.getData('text/plain');
      const fromListId = e.dataTransfer.getData('fromList');
      const toListId = column.dataset.listId;
      
      if (fromListId !== toListId) {
        await moveTask(taskId, fromListId, toListId);
        updateTasks();
      }
    });
  });
}

async function moveTask(taskId, fromListId, toListId) {
  try {
    // Get the task
    const getUrl = 'https://www.googleapis.com/tasks/v1/lists/' + fromListId + '/tasks/' + taskId;
    const getResponse = await fetch(getUrl, { headers: { 'Authorization': 'Bearer ' + currentAccessToken } });
    const task = await getResponse.json();
    
    // Create in new list
    const createUrl = 'https://www.googleapis.com/tasks/v1/lists/' + toListId + '/tasks';
    await fetch(createUrl, {
      method: 'POST',
      headers: { 
        'Authorization': 'Bearer ' + currentAccessToken,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ title: task.title, notes: task.notes })
    });
    
    // Delete from old list
    const deleteUrl = 'https://www.googleapis.com/tasks/v1/lists/' + fromListId + '/tasks/' + taskId;
    await fetch(deleteUrl, {
      method: 'DELETE',
      headers: { 'Authorization': 'Bearer ' + currentAccessToken }
    });
  } catch (error) {
    console.error('Move task error:', error);
  }
}

function setupTaskCheckboxes() {
  document.querySelectorAll('.task-checkbox').forEach(checkbox => {
    checkbox.addEventListener('click', async (e) => {
      const taskItem = e.target.closest('.task-item');
      const taskId = taskItem.dataset.taskId;
      const listId = taskItem.dataset.listId;
      
      try {
        const url = 'https://www.googleapis.com/tasks/v1/lists/' + listId + '/tasks/' + taskId;
        await fetch(url, {
          method: 'PATCH',
          headers: { 
            'Authorization': 'Bearer ' + currentAccessToken,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ status: 'completed' })
        });
        taskItem.style.opacity = '0';
        setTimeout(() => updateTasks(), 500);
      } catch (error) {
        console.error('Complete task error:', error);
      }
    });
  });
}

function initDashboard() {
  document.getElementById('setupPage').style.display = 'none';
  document.getElementById('dashboard').classList.add('active');
  updateTime();
  setInterval(updateTime, 1000);
  updateWeather();
  updateForecast();
  setInterval(updateWeather, 300000);
  setInterval(updateForecast, 300000);
  updateCalendar();
  setInterval(updateCalendar, 300000);
  loadGitHubPhotos();
  setupTasksAuth();
  checkTasksAuth();
}

handleOAuthCallback().then(handled => {
  if (!handled) {
    if (loadConfig()) {
      initDashboard();
    } else {
      document.getElementById('setupPage').style.display = 'block';
    }
  }
});
</script>
</body>
</html>
